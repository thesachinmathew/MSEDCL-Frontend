<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSEDCL – Capture Reading</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <div class="brand-icon">
          <svg width="28" height="28" viewBox="0 0 36 36" fill="none"><path d="M18 4L30 12V24L18 32L6 24V12L18 4Z" stroke="url(#g)" stroke-width="2.2" fill="none"/><defs><linearGradient id="g" x1="6" y1="4" x2="30" y2="32"><stop offset="0%" stop-color="#10B981"/><stop offset="100%" stop-color="#F59E0B"/></linearGradient></defs></svg>
        </div>
        <div style="display: flex; flex-direction: column; line-height: 1.2;">
          <span class="brand-name" style="font-size: 20px;">MSEDCL</span>
          <span style="font-size: 9px; color: var(--gray-500); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Meter Reader</span>
        </div>
      </div>

      <ul class="nav-menu">
        <li class="nav-item" id="navDashboard"><a href="index.html">Dashboard</a></li>
        <li class="nav-item active"><a href="capture.html">Capture Reading</a></li>
        <li class="nav-item" id="navCustomers"><a href="customers.html">Customers</a></li>
        <li class="nav-item"><a href="history.html">History</a></li>
      </ul>

      <div class="nav-user" onclick="handleLogout()">
        <div class="user-avatar"><span id="userInitials">FT</span></div>
        <div class="user-info">
          <div class="user-name" id="userName">Field Tech</div>
          <div class="user-role" id="userRole">Technician</div>
        </div>
      </div>
    </div>
  </nav>

  <main class="main-wrapper">
    <section class="card" style="padding:28px; border-radius:16px;">
      <h2 style="margin-bottom:12px;">Capture Meter Reading</h2>

      <!-- Customer selection -->
      <div style="display:flex; gap:12px; align-items:flex-start; margin-bottom:18px; flex-wrap:wrap;">
        <div style="flex:1; min-width:260px; position:relative;">
          <label for="customerIdInput" style="font-weight:600; font-size:14px; color:var(--gray-700)">Customer ID / Search</label>
          <input id="customerIdInput" placeholder="Type ID or name (eg. CUST001)" autocomplete="off" class="input" style="width:100%; margin-top:6px;">
          <div id="customerDropdown" class="dropdown"></div>
        </div>

        <div style="min-width:220px; display:flex; gap:8px; align-items:center;">
          <button id="createCustomerBtn" class="btn-hero secondary" style="padding:10px 16px;">+ New Customer</button>
          <button id="clearCustomerBtn" class="btn-hero" style="background:#fff; border:1px solid var(--gray-200); color:var(--gray-700);">Clear</button>
        </div>
      </div>

      <!-- Selected customer panel -->
      <div id="selectedCustomerInfo" class="hidden card" style="padding:14px; margin-bottom:16px; border-radius:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-weight:700;">Selected Customer</div>
            <div style="color:var(--gray-600); margin-top:6px;">
              <div><strong>ID:</strong> <span id="infoCustomerId"></span></div>
              <div><strong>Name:</strong> <span id="infoCustomerName"></span></div>
              <div><strong>Address:</strong> <span id="infoCustomerAddress"></span></div>
              <div><strong>Phone:</strong> <span id="infoCustomerPhone"></span></div>
            </div>
          </div>
          <div>
            <div style="font-size:13px; color:var(--gray-500)">You can take photo or upload an image below</div>
          </div>
        </div>
      </div>

      <div id="uploadDisabledMessage" style="margin-bottom:16px;">
        <div class="hint">Select or create a customer to enable image upload</div>
      </div>

      <!-- Upload area -->
      <div id="uploadArea" class="hidden card" style="padding:18px; border-radius:12px;">
        <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
          <div style="flex:1; min-width:260px;">
            <div id="uploadPlaceholder" class="upload-placeholder">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 3l4 4h-3v4h-2V7H8l4-4z"/></svg>
              <div style="margin-top:8px; color:var(--gray-600)">Take a photo or drop an image</div>
            </div>

            <div id="imagePreview" class="hidden" style="margin-top:10px;">
              <img id="previewImg" src="" alt="preview" style="max-width:100%; border-radius:8px; box-shadow:var(--shadow-sm);" />
              <div style="margin-top:8px; display:flex; gap:8px;">
                <button id="retakeBtn" class="btn-hero secondary" style="padding:8px 12px;">Retake</button>
                <button id="uploadBtn" class="btn-hero" style="padding:8px 12px; background:#f3f4f6; color:var(--gray-700);">Replace</button>
              </div>
            </div>

            <input id="fileInput" type="file" accept="image/*" class="hidden" capture="environment" />
          </div>

          <div style="min-width:170px; display:flex; flex-direction:column; gap:10px;">
            <button id="cameraBtn" class="btn-hero primary" style="padding:12px 16px;">Take Photo / Choose</button>
            <button id="submitBtn" class="btn-hero" style="padding:12px 16px;">Upload & Process</button>

            <div id="loadingState" class="hidden" style="padding:8px 12px; border-radius:8px; background:#fff; border:1px solid var(--gray-100);">
              Processing… <span style="color:var(--gray-400); font-size:13px; margin-left:8px">(waiting for backend)</span>
            </div>
          </div>
        </div>

        <div style="margin-top:12px; color:var(--gray-500); font-size:13px;">
          If the backend marks the reading <strong>UNCLEAR</strong> you'll be prompted to retake. If it detects an <strong>ANOMALY</strong> you can override (if valid) or retake.
        </div>
      </div>
    </section>

    <!-- Create Customer Modal -->
    <div id="createCustomerModal" class="modal hidden">
      <div class="modal-card">
        <h3>Create New Customer</h3>
        <form id="createCustomerForm">
          <label>Customer ID</label>
          <input id="newCustomerId" required class="input" />
          <label>Name</label>
          <input id="customerName" required class="input" />
          <label>Address</label>
          <input id="customerAddress" class="input" />
          <label>Phone</label>
          <input id="customerPhone" class="input" />
          <label>Email</label>
          <input id="customerEmail" class="input" />
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
            <button id="cancelModalBtn" type="button" class="btn-hero secondary">Cancel</button>
            <button type="submit" class="btn-hero primary">Create</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Anomaly Modal -->
    <div id="anomalyModal" class="modal hidden">
      <div class="modal-card">
        <h3>Anomaly Detected</h3>
        <p id="anomalyMessage" style="color:var(--gray-700)"></p>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button id="retakeAnomalyBtn" class="btn-hero secondary">Retake Photo</button>
          <button id="overrideBtn" class="btn-hero primary">Override & Save</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden"><div id="toastMessage"></div></div>

  </main>

  <script src="script.js"></script>
  <script>
    // Check authentication and set user info
    window.addEventListener('DOMContentLoaded', () => {
      const currentUser = sessionStorage.getItem('currentUser');
      
      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }

      const user = JSON.parse(currentUser);
      
      // Update UI with user info
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userRole').textContent = user.role === 'admin' ? 'Admin' : 'Technician';
      
      // Set initials
      const initials = user.name.split(' ').map(n => n[0]).join('');
      document.getElementById('userInitials').textContent = initials;

      // Hide "New Customer" button for technicians
      if (user.role === 'technician') {
        const createBtn = document.getElementById('createCustomerBtn');
        if (createBtn) createBtn.style.display = 'none';
        
        // Hide dashboard link for technicians
        const dashNav = document.getElementById('navDashboard');
        if (dashNav) dashNav.style.display = 'none';
        
        // Hide customers link for technicians
        const custNav = document.getElementById('navCustomers');
        if (custNav) custNav.style.display = 'none';
      }
    });

    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('currentUser');
        window.location.href = 'login.html';
      }
    }
  </script>
</body>
</html>